### 서브 쿼리
- 하나의 SQL 쿼리 문 안에 포함된 또 다른 SELECT 쿼리
- WHERE 절에서는 '동적 필터'로, SELECT 절에서는 '새로운 컬럼'으로 활약하는 모습
- FROM 절에 위치하는 서브쿼리는, 그 실행 결과가 마치 하나의 독립된 가상 테이블처럼 사용

#### 분류
- 반환되는 행(row) 과 컬럼(col) 수, 그리고 사용 위치에 따라 분류
  - 스칼라 서브쿼리 (단일 행 & 단일 컬럼)
  - 다중 행 서브쿼리 (단일 컬럼) : IN, ANY, ALL 등과 함께 사용. 값 목록(list)을 반환
  - 다중 컬럼 서브쿼리 : (c1, c2) = (SELECT c1, c2 ...) 처럼 여러 컬럼 조합을 비교. 행이 여러 개인 경우 (c1, c2) IN (SELECT ...) 형태로 사용
  - 테이블 서브쿼리(파생 테이블 / 인라인 뷰) : FROM (SELECT ...) AS alias 형태로 가상의 테이블 생성 → 다른 테이블과 JOIN 등으로 사용

#### 스칼라 서브쿼리
- 서브 쿼리가 (단일 행 & 단일 컬럼)을 반환
- SELECT, WHERE, HAVING
- =, >, < 등 단일값 비교에 사용

#### 다중 행 서브쿼리
- 서브쿼리가 여러 개의 행을 반환
- WHERE, HAVING
- IN, ANY, ALL 과 함께 사용
  - IN : 서브쿼리가 반환한 목록 중 하나와 일치하면 참
- ANY 와 ALL 은 주로 > , < 와 같은 비교 연산자와 함께 사용
  - `> ANY (서브쿼리)` : 서브쿼리가 반환한 여러 결과값 중 어느 하나보다만 크면 참이다. 즉, 최소값보다 크면 참
  - `> ALL (서브쿼리)` : 서브쿼리가 반환한 여러 결과값 모두보다 커야만 참이다. 즉, 최대값보다 커야 참
  - `< ANY (서브쿼리)` : 최대값보다 작으면 참
  - `< ALL (서브쿼리)` : 최소값보다 작으면 참
  - `= ANY  (서브쿼리)` : IN 과 완전히 동일
- 집계함수 MIN, MAX가 더 명확하고 직관적

#### 다중 컬럼 서브쿼리
- 두 개 이상의 컬럼 조합(튜플)을 동시에 비교해야 할 때 사용
- WHERE, HAVING
- 다중 컬럼 서브쿼리를 = 연산자와 함께 사용할 때는, 서브쿼리의 결과가 반드시 하나의 행이어야 한다
- 다중 컬럼 서브쿼리 역시 서브쿼리의 결과가 여러 행 일 수 있다
  - IN연산자 사용

#### 테이블 서브쿼리
- 가상의 테이블을 생성하여 다른 테이블과 JOIN 등 재가공
- FROM
- 집계된 결과를 가지고 다시 한번 조인이나 필터링을 수행해야 할 때 매우 유용
- 인라인 뷰라고도 부른다
- FROM 절에서 상관 서브쿼리 -> 너무 복잡, 성능도 별로라 잘 사용x. LATERAL이라는 특별한 키워드 사용

### 상관 서브쿼리, 비상관 서브쿼리
- 상관 서브쿼리
  - 메인쿼리와 서브쿼리가 서로 연관지어 동작
  - 메인쿼리 한행의 값을 서브쿼리에 전달, 실행 (주로 pk)
  - 서브쿼리의 결과를 이용해 메인쿼리의 where조건 활용
- 비상관 서브쿼리
  - 서브쿼리가 단 한 번 실행된 후, 그 결과를 메인쿼리가 사용
- IN vs EXISTS
- IN
  - 서브쿼리를 먼저 실행해 결과 목록을 만든 후, 메인쿼리에서 사용
  - 서브쿼리 결과가 작을 때 직관적이고 빠를 수 있음
  - 대상 테이블 전체를 스캔
- EXISTS
  - 메인쿼리의 각 행에 대해 서브쿼리를 실행하여 조건 확인 
  - 상관 서브쿼리. 서브쿼리 테이블이 클 때 효율적
  - 조건을 만족하는 첫 행만 찾으면 스캔을 멈춤

### 서브쿼리 vs JOIN
- 실제로 많은 문제는 JOIN 으로도, 서브쿼리로도 해결할 수 있다
- 일반적으로, 데이터베이스는 JOIN 이 서브쿼리보다 성능이 더 좋거나 최소한 동일한 경우가 많다
  - JOIN 구문은 옵티마이저에게 더 많은 정보를 제공 (보통)
  - 간단한 서브쿼리는 내부적으로 최적의 JOIN 구문으로 자동 변환해서 실행하는 경우가 많다
- 서브쿼리가 직관적이어서 가독성이 좋은 경우가 많음
- 가이드라인
  - JOIN 우선적으로 고려
  - 성능이 아주 중요한 쿼리가 아니고, JOIN 으로 표현하기 너무 복잡하거나, 서브쿼리의 가독성이 훨씬 좋다면 서브쿼리를 사용
  - EXISTS 를 활용